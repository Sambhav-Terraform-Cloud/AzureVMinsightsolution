  # Add logging and monitoring extensions. This extension is needed for other extensions
resource "azurerm_virtual_machine_extension" "azure-monitor-agent" {
  
  name                  = "AzureMonitorLinuxAgent"
  virtual_machine_id    = azurerm_linux_virtual_machine.myLinuxVm1.id
  publisher             = "Microsoft.Azure.Monitor"
  type                  = "AzureMonitorLinuxAgent"
  type_handler_version  =  1.24
  automatic_upgrade_enabled  = true
  auto_upgrade_minor_version = true
  
  settings = jsonencode({
    workspaceId               = azurerm_log_analytics_workspace.law.workspace_id
    azureResourceId           = azurerm_linux_virtual_machine.myLinuxVm1.id
    stopOnMultipleConnections = false

    authentication = {
      managedIdentity = {
        identifier-name  = "mi_res_id"
        identifier-value = azurerm_user_assigned_identity.myUserassignedIdentiy.id
      }
    }

  })
  protected_settings = jsonencode({
    "workspaceKey" = azurerm_log_analytics_workspace.law.primary_shared_key
  })
}
